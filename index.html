<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UFI集团年会答题挑战赛</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Arial', 'Microsoft YaHei', sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #006633 0%, #00994d 100%);
            color: white;
            min-height: 100vh;
            overflow: hidden;
        }
        
        .container {
            display: flex;
            flex-direction: column;
            height: 100vh;
            padding: 20px;
        }
        
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 0;
            border-bottom: 3px solid rgba(255, 255, 255, 0.2);
            margin-bottom: 20px;
        }
        
        .logo {
            font-size: 2.5rem;
            font-weight: bold;
            background: linear-gradient(90deg, #00cc66, #00994d);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            text-shadow: 0 0 10px rgba(0, 204, 102, 0.3);
        }
        
        .event-title {
            font-size: 2.8rem;
            text-align: center;
            color: #fff;
            text-shadow: 0 0 15px rgba(255, 255, 255, 0.5);
            letter-spacing: 2px;
        }
        
        .timer-section {
            display: flex;
            justify-content: center;
            margin-bottom: 10px;
        }
        
        .timer {
            background: rgba(0, 0, 0, 0.4);
            border-radius: 20px;
            padding: 15px 40px;
            font-size: 3.5rem;
            font-weight: bold;
            color: #ffdd00;
            text-shadow: 0 0 10px rgba(255, 221, 0, 0.7);
            border: 3px solid #ffdd00;
            box-shadow: 0 0 20px rgba(255, 221, 0, 0.5);
        }
        
        .main-content {
            display: flex;
            flex: 1;
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .question-section {
            flex: 3;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            padding: 30px;
            backdrop-filter: blur(10px);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            display: flex;
            flex-direction: column;
        }
        
        .question-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 20px;
        }
        
        .question-number {
            font-size: 1.8rem;
            color: #ffdd00;
        }
        
        .question-type {
            font-size: 1.5rem;
            background: rgba(0, 204, 102, 0.2);
            padding: 8px 20px;
            border-radius: 50px;
        }
        
        .question-text {
            font-size: 2.8rem;
            line-height: 1.4;
            margin-bottom: 40px;
            text-align: center;
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        
        .answers-section {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
        }
        
        .answer {
            background: rgba(255, 255, 255, 0.15);
            border-radius: 15px;
            padding: 25px;
            font-size: 2rem;
            cursor: pointer;
            transition: all 0.3s;
            border: 3px solid transparent;
            text-align: center;
        }
        
        .answer:hover {
            background: rgba(255, 255, 255, 0.25);
            transform: translateY(-5px);
        }
        
        .answer.selected {
            background: rgba(255, 221, 0, 0.3);
            border-color: #ffdd00;
            box-shadow: 0 0 20px rgba(255, 221, 0, 0.5);
        }
        
        .answer.correct {
            background: rgba(46, 204, 113, 0.3);
            border-color: #2ecc71;
            box-shadow: 0 0 20px rgba(46, 204, 113, 0.5);
        }
        
        .answer.wrong {
            background: rgba(231, 76, 60, 0.3);
            border-color: #e74c3c;
            box-shadow: 0 0 20px rgba(231, 76, 60, 0.5);
        }
        
        .ranking-section {
            flex: 1;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            padding: 25px;
            backdrop-filter: blur(10px);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            display: flex;
            flex-direction: column;
        }
        
        .ranking-title {
            font-size: 2rem;
            text-align: center;
            margin-bottom: 25px;
            color: #ffdd00;
            text-shadow: 0 0 10px rgba(255, 221, 0, 0.5);
        }
        
        .ranking-list {
            flex: 1;
            overflow-y: auto;
        }
        
        .ranking-item {
            display: flex;
            align-items: center;
            padding: 15px;
            margin-bottom: 15px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            transition: all 0.3s;
        }
        
        .ranking-item:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateX(5px);
        }
        
        .rank {
            font-size: 1.8rem;
            font-weight: bold;
            width: 50px;
            text-align: center;
        }
        
        .rank-1 {
            color: gold;
            text-shadow: 0 0 10px gold;
        }
        
        .rank-2 {
            color: silver;
            text-shadow: 0 0 10px silver;
        }
        
        .rank-3 {
            color: #cd7f32;
            text-shadow: 0 0 10px #cd7f32;
        }
        
        .user-info {
            flex: 1;
            font-size: 1.5rem;
            display: flex;
            flex-direction: column;
        }
        
        .user-name {
            font-weight: bold;
        }
        
        .user-time {
            font-size: 1.2rem;
            color: rgba(255, 255, 255, 0.7);
        }
        
        .score {
            font-size: 1.8rem;
            font-weight: bold;
            color: #ffdd00;
            min-width: 80px;
            text-align: right;
        }
        
        .control-panel {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 30px;
            background: rgba(0, 0, 0, 0.4);
            border-radius: 15px;
            margin-top: 10px;
        }
        
        .control-btn {
            background: linear-gradient(90deg, #006633, #00994d);
            color: white;
            border: none;
            padding: 15px 30px;
            font-size: 1.5rem;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .control-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0, 102, 51, 0.4);
        }
        
        .control-btn.next {
            background: linear-gradient(90deg, #00cc66, #00994d);
        }
        
        .control-btn.next:hover {
            box-shadow: 0 5px 15px rgba(0, 204, 102, 0.4);
        }
        
        .control-btn.reset {
            background: linear-gradient(90deg, #e74c3c, #c0392b);
        }
        
        .control-btn.reset:hover {
            box-shadow: 0 5px 15px rgba(231, 76, 60, 0.4);
        }
        
        .qr-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.85);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            backdrop-filter: blur(10px);
        }
        
        .qr-container {
            background: linear-gradient(135deg, #006633 0%, #00994d 100%);
            border-radius: 25px;
            padding: 40px;
            text-align: center;
            max-width: 600px;
            width: 90%;
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.5);
            border: 3px solid rgba(255, 221, 0, 0.5);
        }
        
        .qr-title {
            font-size: 3rem;
            margin-bottom: 20px;
            color: #ffdd00;
            text-shadow: 0 0 15px rgba(255, 221, 0, 0.5);
        }
        
        .qr-subtitle {
            font-size: 1.8rem;
            margin-bottom: 30px;
            color: #fff;
            opacity: 0.9;
        }
        
        .qr-code-container {
            background: white;
            padding: 20px;
            border-radius: 15px;
            display: inline-block;
            margin-bottom: 30px;
            min-height: 290px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        #qrcode-img {
            width: 250px;
            height: 250px;
        }
        
        .qr-instructions {
            font-size: 1.6rem;
            margin-bottom: 25px;
            line-height: 1.5;
            color: #ffdd00;
        }
        
        .qr-stats {
            font-size: 1.8rem;
            margin-top: 20px;
            padding: 15px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
        }
        
        .close-qr-btn {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(255, 255, 255, 0.1);
            border: none;
            color: white;
            font-size: 2.5rem;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .close-qr-btn:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: rotate(90deg);
        }
        
        .qr-show-btn {
            background: linear-gradient(90deg, #9b59b6, #8e44ad);
            color: white;
            border: none;
            padding: 12px 25px;
            font-size: 1.4rem;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 10px;
            margin-left: 15px;
        }
        
        .qr-show-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(155, 89, 182, 0.4);
        }
        
        .admin-panel {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .participant-count {
            font-size: 1.6rem;
            color: #ffdd00;
            background: rgba(255, 255, 255, 0.1);
            padding: 8px 20px;
            border-radius: 50px;
        }
        
        .progress-section {
            margin-top: 20px;
            text-align: center;
        }
        
        .progress-text {
            font-size: 1.5rem;
            margin-bottom: 10px;
            color: #ffdd00;
        }
        
        .progress-bar {
            height: 20px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #00cc66, #00994d);
            width: 0%;
            transition: width 0.5s;
            border-radius: 10px;
        }
        
        .score-info {
            font-size: 1.5rem;
            text-align: center;
            margin-top: 10px;
            color: #ffdd00;
        }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
        
        .pulse {
            animation: pulse 1s infinite;
        }
        
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        @keyframes slideOut {
            from { transform: translateX(0); opacity: 1; }
            to { transform: translateX(100%); opacity: 0; }
        }
        
        @media (max-width: 1200px) {
            .question-text {
                font-size: 2.2rem;
            }
            
            .answer {
                font-size: 1.7rem;
                padding: 20px;
            }
        }
        
        @media (max-width: 768px) {
            .header {
                flex-direction: column;
                gap: 15px;
            }
            
            .event-title {
                font-size: 2rem;
            }
            
            .question-text {
                font-size: 1.8rem;
            }
            
            .answers-section {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <!-- 二维码加入覆盖层 -->
    <div class="qr-overlay" id="qrOverlay" style="display: none;">
        <div class="qr-container">
            <button class="close-qr-btn" id="closeQrBtn">
                <i class="fas fa-times"></i>
            </button>
            
            <div class="qr-title">扫码加入UFI答题挑战</div>
            <div class="qr-subtitle">扫描二维码，输入姓名参与UFI知识竞赛</div>
            
            <div class="qr-code-container">
                <!-- 使用Google Chart API生成二维码 -->
                <img id="qrcode-img" width="250" height="250" alt="扫描二维码加入UFI答题">
            </div>
            
            <div class="qr-instructions">
                <p><i class="fas fa-mobile-alt"></i> 打开手机微信/浏览器</p>
                <p><i class="fas fa-camera"></i> 扫描上方二维码</p>
                <p><i class="fas fa-edit"></i> 输入您的姓名</p>
                <p><i class="fas fa-trophy"></i> 赢取精美礼品</p>
            </div>
            
            <div class="qr-stats">
                已加入人数: <span id="participantCount">0</span> 人
            </div>
        </div>
    </div>
    
    <!-- 主界面 -->
    <div class="container">
        <div class="header">
            <div class="logo">UFI集团</div>
            <div class="event-title">2024年度UFI集团知识挑战赛</div>
            <div class="timer-section">
                <div class="timer" id="timer">30</div>
            </div>
        </div>
        
        <div class="main-content">
            <div class="question-section">
                <div class="question-header">
                    <div class="question-number" id="question-number">第 1 题</div>
                    <div class="question-type" id="question-type">单选题</div>
                </div>
                
                <div class="question-text" id="question-text">
                    UFI集团成立于哪一年？
                </div>
                
                <div class="answers-section" id="answers-section">
                    <div class="answer" data-index="0">A. 1970</div>
                    <div class="answer" data-index="1">B. 1971</div>
                    <div class="answer" data-index="2">C. 1972</div>
                    <div class="answer" data-index="3">D. 1973</div>
                </div>
                
                <div class="score-info" id="score-info">每题20分 | 答题越快得分越高</div>
            </div>
            
            <div class="ranking-section">
                <div class="ranking-title">实时排名</div>
                <div class="ranking-list" id="ranking-list">
                    <!-- 排名将通过JS动态生成 -->
                    <div class="ranking-item">
                        <div class="rank rank-1">1</div>
                        <div class="user-info">
                            <div class="user-name">等待选手加入...</div>
                            <div class="user-time">扫描二维码参与答题</div>
                        </div>
                        <div class="score">0</div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="progress-section">
            <div class="progress-text">答题进度 (总分: <span id="totalScore">100</span>分)</div>
            <div class="progress-bar">
                <div class="progress-fill" id="progress-fill"></div>
            </div>
        </div>
        
        <div class="control-panel">
            <button class="control-btn reset" id="reset-btn">
                <i class="fas fa-redo"></i> 重置比赛
            </button>
            
            <div class="admin-panel">
                <div class="participant-count">
                    <i class="fas fa-users"></i> 参与: <span id="liveParticipantCount">0</span>
                </div>
                
                <button class="qr-show-btn" id="showQrBtn">
                    <i class="fas fa-qrcode"></i> 显示二维码
                </button>
            </div>
            
            <button class="control-btn next" id="next-btn">
                <i class="fas fa-forward"></i> 下一题
            </button>
        </div>
    </div>

    <script>
        // UFI集团专属题目数据
        const questions = [
            {
                question: "UFI集团成立于哪一年？",
                type: "单选题",
                answers: ["A. 1970", "B. 1971", "C. 1972", "D. 1973"],
                correct: 1,
                explanation: "UFI集团成立于1971年，是全球过滤系统领域的领先企业。"
            },
            {
                question: "UFI集团的愿景是什么？",
                type: "单选题",
                answers: [
                    "A. 助力共创数字未来",
                    "B. 助力共创绿色未来",
                    "C. 助力共创可以未来",
                    "D. 助力共创商业未来"
                ],
                correct: 1,
                explanation: "UFI集团的愿景是：助力共创绿色未来。"
            },
            {
                question: "UFI的产品服务对象不包括？",
                type: "单选题",
                answers: [
                    "A. 汽车、航空、赛车领域",
                    "B. 航海、液压、工业领域",
                    "C. 消费电子领域",
                    "D. 农用车辆领域"
                ],
                correct: 2,
                explanation: "UFI专注于汽车、航空、赛车、航海、液压、工业、农用车辆等领域，不涉及消费电子领域。"
            },
            {
                question: "UFI的五大关键行为是什么？",
                type: "多选题",
                answers: [
                    "A. 业务导向",
                    "B. 关注外部客户",
                    "C. 流程改进",
                    "D. 跨职能合作",
                    "E. 提高责任心",
                    "F. 不断追求卓越",
                    "G. 多元化与包容性"
                ],
                correct: [0, 1, 2, 3, 4],
                explanation: "UFI五大关键行为：业务导向、关注外部客户、流程改进、跨职能合作、提高责任心。"
            },
            {
                question: "UFI的六大价值观是什么？",
                type: "多选题",
                answers: [
                    "A. 助力共创绿色未来",
                    "B. 可持续创新践行者",
                    "C. 企业家精神的拥护者",
                    "D. 以客户为中心",
                    "E. 追求卓越的激情",
                    "F. 关爱员工",
                    "G. 多元化与包容性"
                ],
                correct: [1, 2, 3, 4, 5, 6],
                explanation: "UFI六大价值观：可持续创新践行者、企业家精神的拥护者、以客户为中心、追求卓越的激情、关爱员工、多元化与包容性。"
            }
        ];

        // 计分规则
        const BASE_SCORE_PER_QUESTION = 20; // 每题基础分20分
        const TOTAL_QUESTIONS = questions.length; // 总题数
        const MAX_TOTAL_SCORE = BASE_SCORE_PER_QUESTION * TOTAL_QUESTIONS; // 总分100分

        // 用户数据结构 - 增加时间相关字段
        let users = [];
        let userCounter = 1;

        // 全局变量
        let currentQuestion = 0;
        let timerValue = 30;
        let startTime; // 记录题目开始时间
        let timerInterval;
        let isAnswered = false;
        let isMultiChoice = false;

        // DOM元素
        const timerElement = document.getElementById('timer');
        const questionNumberElement = document.getElementById('question-number');
        const questionTypeElement = document.getElementById('question-type');
        const questionTextElement = document.getElementById('question-text');
        const answersSectionElement = document.getElementById('answers-section');
        const rankingListElement = document.getElementById('ranking-list');
        const progressFillElement = document.getElementById('progress-fill');
        const totalScoreElement = document.getElementById('totalScore');
        const resetBtnElement = document.getElementById('reset-btn');
        const nextBtnElement = document.getElementById('next-btn');
        const qrOverlayElement = document.getElementById('qrOverlay');
        const closeQrBtnElement = document.getElementById('closeQrBtn');
        const showQrBtnElement = document.getElementById('showQrBtn');
        const participantCountElement = document.getElementById('participantCount');
        const liveParticipantCountElement = document.getElementById('liveParticipantCount');
        const qrcodeImgElement = document.getElementById('qrcode-img');

        // 初始化页面
        function initPage() {
            totalScoreElement.textContent = MAX_TOTAL_SCORE;
            loadQuestion(currentQuestion);
            startTimer();
            updateRanking();
            
            // 添加答题事件监听
            const answerElements = document.querySelectorAll('.answer');
            answerElements.forEach(answer => {
                answer.addEventListener('click', () => selectAnswer(answer));
            });
            
            // 添加按钮事件监听
            resetBtnElement.addEventListener('click', resetGame);
            nextBtnElement.addEventListener('click', nextQuestion);
            closeQrBtnElement.addEventListener('click', hideQrCode);
            showQrBtnElement.addEventListener('click', showQrCode);
            
            // 生成二维码
            generateQRCode();
            
            // 从本地存储加载已有用户
            loadUsersFromStorage();
            
            // 更新参与者计数
            updateParticipantCount();
            
            // 每3秒检查新用户
            setInterval(checkForNewUsers, 3000);
            
            console.log("UFI答题系统初始化完成！");
        }

        // 生成二维码（使用Google Chart API）
        function generateQRCode() {
            try {
                // 获取当前页面URL
                const currentUrl = window.location.href;
                const baseUrl = currentUrl.substring(0, currentUrl.lastIndexOf('/') + 1);
                const joinPageUrl = baseUrl + 'join.html';
                
                console.log("当前页面URL:", currentUrl);
                console.log("基础URL:", baseUrl);
                console.log("加入页面URL:", joinPageUrl);
                
                // 使用Google Chart API生成二维码
                const qrCodeUrl = `https://chart.googleapis.com/chart?cht=qr&chs=250x250&chl=${encodeURIComponent(joinPageUrl)}&choe=UTF-8&chld=H|0`;
                
                // 设置图片src
                qrcodeImgElement.src = qrCodeUrl;
                qrcodeImgElement.alt = "扫描加入UFI答题挑战 - " + joinPageUrl;
                
                console.log("二维码生成成功，URL:", qrCodeUrl);
                
                // 备用：如果Google API不可用，显示链接
                qrcodeImgElement.onerror = function() {
                    console.log("Google二维码API不可用，使用备用方案");
                    qrcodeImgElement.alt = "请手动访问: " + joinPageUrl;
                    qrcodeImgElement.style.display = 'none';
                    
                    // 显示链接
                    const container = document.querySelector('.qr-code-container');
                    container.innerHTML = `
                        <div style="padding: 20px; text-align: center;">
                            <div style="color: red; margin-bottom: 10px;">二维码生成失败</div>
                            <div style="color: black; margin-bottom: 15px;">请手动访问：</div>
                            <div style="color: blue; word-break: break-all; font-size: 14px;">${joinPageUrl}</div>
                            <div style="color: black; margin-top: 15px;">或联系工作人员获取链接</div>
                        </div>
                    `;
                };
                
            } catch (error) {
                console.error("生成二维码时出错:", error);
            }
        }

        // 显示二维码界面
        function showQrCode() {
            qrOverlayElement.style.display = 'flex';
            updateParticipantCount();
            
            // 重新生成二维码（确保URL是最新的）
            generateQRCode();
        }

        // 隐藏二维码界面
        function hideQrCode() {
            qrOverlayElement.style.display = 'none';
        }

        // 从本地存储加载用户
        function loadUsersFromStorage() {
            try {
                const storedUsers = localStorage.getItem('ufiQuizUsers');
                if (storedUsers) {
                    users = JSON.parse(storedUsers);
                    console.log("从本地存储加载用户:", users.length, "个");
                }
            } catch (error) {
                console.error("加载用户数据时出错:", error);
                users = [];
            }
        }

        // 保存用户到本地存储
        function saveUsersToStorage() {
            try {
                localStorage.setItem('ufiQuizUsers', JSON.stringify(users));
            } catch (error) {
                console.error("保存用户数据时出错:", error);
            }
        }

        // 检查新用户加入
        function checkForNewUsers() {
            const oldCount = users.length;
            loadUsersFromStorage();
            const newCount = users.length;
            
            if (newCount > oldCount) {
                updateParticipantCount();
                updateRanking();
                
                // 显示新用户通知
                const newUser = users[users.length - 1];
                showNewUserNotification(newUser.name);
            }
        }

        // 显示新用户加入通知
        function showNewUserNotification(userName) {
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 100px;
                right: 20px;
                background: linear-gradient(90deg, #00cc66, #00994d);
                color: white;
                padding: 15px 25px;
                border-radius: 10px;
                font-size: 1.6rem;
                z-index: 1001;
                box-shadow: 0 5px 15px rgba(0,0,0,0.3);
                animation: slideIn 0.5s ease-out;
            `;
            
            notification.innerHTML = `<i class="fas fa-user-plus"></i> ${userName} 加入了UFI知识挑战赛`;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.animation = 'slideOut 0.5s ease-out';
                setTimeout(() => notification.remove(), 500);
            }, 3000);
        }

        // 更新参与者计数
        function updateParticipantCount() {
            const count = users.length;
            participantCountElement.textContent = count;
            liveParticipantCountElement.textContent = count;
        }

        // 加载题目
        function loadQuestion(index) {
            const question = questions[index];
            isAnswered = false;
            startTime = Date.now(); // 记录题目开始时间
            
            // 更新题目信息
            questionNumberElement.textContent = `第 ${index + 1} 题`;
            questionTypeElement.textContent = question.type;
            questionTextElement.textContent = question.question;
            
            // 检查是否为多选题
            isMultiChoice = question.type === "多选题";
            
            // 清空答案区域
            answersSectionElement.innerHTML = '';
            
            // 添加答案选项
            question.answers.forEach((answer, i) => {
                const answerElement = document.createElement('div');
                answerElement.className = 'answer';
                answerElement.dataset.index = i;
                answerElement.textContent = answer;
                answerElement.addEventListener('click', () => selectAnswer(answerElement));
                answersSectionElement.appendChild(answerElement);
            });
            
            // 添加计分说明
            const scoreInfo = document.createElement('div');
            scoreInfo.className = 'score-info';
            scoreInfo.textContent = `每题${BASE_SCORE_PER_QUESTION}分 | 答题越快得分越高`;
            scoreInfo.id = 'score-info';
            answersSectionElement.parentNode.appendChild(scoreInfo);
            
            // 更新进度条
            progressFillElement.style.width = `${((index + 1) / questions.length) * 100}%`;
            
            // 重置定时器
            timerValue = 30;
            timerElement.textContent = timerValue;
            timerElement.classList.remove('pulse');
            
            // 禁用下一题按钮
            nextBtnElement.disabled = true;
            nextBtnElement.style.opacity = '0.5';
            nextBtnElement.style.cursor = 'not-allowed';
            
            // 如果是多选题，更新UI提示
            if (isMultiChoice) {
                const hint = document.createElement('div');
                hint.style.textAlign = 'center';
                hint.style.marginTop = '10px';
                hint.style.color = '#ffdd00';
                hint.style.fontSize = '1.5rem';
                hint.textContent = '提示：本题为多选题，可选择多个答案';
                answersSectionElement.parentNode.insertBefore(hint, answersSectionElement.nextSibling);
            }
            
            // 重置所有用户的当前答案
            users.forEach(user => user.currentAnswer = null);
        }

        // 计算答题得分（考虑时间因素）
        function calculateScore(answerTime) {
            // 基础分20分
            let score = BASE_SCORE_PER_QUESTION;
            
            // 时间奖励：答题时间越短，奖励越高
            // 满分30秒，每提前1秒增加1分，最多加10分
            const timeBonus = Math.max(0, Math.min(10, 30 - answerTime));
            score += timeBonus;
            
            return score;
        }

        // 计算答题所用时间（秒）
        function getAnswerTime() {
            const endTime = Date.now();
            const timeElapsed = Math.floor((endTime - startTime) / 1000); // 转换为秒
            return Math.min(30, timeElapsed); // 最大30秒
        }

        // 选择答案
        function selectAnswer(answerElement) {
            if (isAnswered) return;
            
            const selectedIndex = parseInt(answerElement.dataset.index);
            const answerTime = getAnswerTime(); // 获取答题时间
            
            // 如果是单选题
            if (!isMultiChoice) {
                // 移除所有选项的选择状态
                document.querySelectorAll('.answer').forEach(el => {
                    el.classList.remove('selected');
                });
                
                // 设置当前选择
                answerElement.classList.add('selected');
                
                // 模拟用户答题
                simulateUserAnswers(selectedIndex, answerTime);
                
                // 显示正确答案
                showCorrectAnswer();
            } else {
                // 多选题：切换选择状态
                answerElement.classList.toggle('selected');
                
                // 获取所有已选择的选项
                const selectedIndices = Array.from(document.querySelectorAll('.answer.selected'))
                    .map(el => parseInt(el.dataset.index));
                
                // 如果至少选择了一个选项，模拟用户答题
                if (selectedIndices.length > 0) {
                    const answerTime = getAnswerTime();
                    simulateUserAnswers(selectedIndices, answerTime);
                }
            }
        }

        // 模拟用户答题（带时间参数）
        function simulateUserAnswers(selectedIndex, answerTime) {
            // 随机为每个用户分配答案
            users.forEach(user => {
                // 80%的用户会答题，20%可能不答
                if (Math.random() < 0.8) {
                    if (isMultiChoice) {
                        // 多选题：随机选择部分选项
                        const correctIndices = questions[currentQuestion].correct;
                        const userAnswer = [];
                        
                        // 用户有一定概率答对
                        const isCorrect = Math.random() < 0.6;
                        
                        if (isCorrect) {
                            // 答对的情况
                            userAnswer.push(...correctIndices);
                            // 可能额外选择一些错误选项
                            if (Math.random() < 0.3) {
                                const allIndices = Array.from({length: questions[currentQuestion].answers.length}, (_, i) => i);
                                const wrongIndices = allIndices.filter(i => !correctIndices.includes(i));
                                if (wrongIndices.length > 0) {
                                    userAnswer.push(wrongIndices[Math.floor(Math.random() * wrongIndices.length)]);
                                }
                            }
                        } else {
                            // 答错的情况
                            const allIndices = Array.from({length: questions[currentQuestion].answers.length}, (_, i) => i);
                            const randomCount = Math.min(1 + Math.floor(Math.random() * 3), allIndices.length);
                            
                            // 随机选择选项
                            for (let i = 0; i < randomCount; i++) {
                                const randomIndex = Math.floor(Math.random() * allIndices.length);
                                userAnswer.push(allIndices[randomIndex]);
                                allIndices.splice(randomIndex, 1);
                            }
                        }
                        
                        user.currentAnswer = [...new Set(userAnswer)]; // 去重
                    } else {
                        // 单选题
                        const correctIndex = questions[currentQuestion].correct;
                        // 用户有一定概率答对
                        const isCorrect = Math.random() < 0.7;
                        user.currentAnswer = isCorrect ? correctIndex : 
                            (selectedIndex + 1) % questions[currentQuestion].answers.length;
                    }
                    
                    user.answered++;
                    
                    // 检查答案是否正确
                    const isCorrect = checkAnswer(user.currentAnswer);
                    if (isCorrect) {
                        user.correct++;
                        // 计算得分（考虑时间）
                        const userAnswerTime = Math.floor(answerTime * (0.8 + Math.random() * 0.4)); // 模拟不同用户的答题时间
                        const questionScore = calculateScore(userAnswerTime);
                        user.score += questionScore;
                        
                        // 记录答题时间（用于排名）
                        if (!user.answerTimes) user.answerTimes = [];
                        user.answerTimes.push(userAnswerTime);
                        
                        // 更新用户平均时间
                        user.avgTime = user.answerTimes.reduce((a, b) => a + b, 0) / user.answerTimes.length;
                    }
                } else {
                    // 用户未答题
                    user.currentAnswer = null;
                }
            });
            
            // 保存用户数据
            saveUsersToStorage();
            
            // 更新排名（考虑分数和时间）
            updateRanking();
            
            // 如果不是多选题，自动显示答案
            if (!isMultiChoice) {
                isAnswered = true;
                nextBtnElement.disabled = false;
                nextBtnElement.style.opacity = '1';
                nextBtnElement.style.cursor = 'pointer';
                clearInterval(timerInterval);
                timerElement.classList.add('pulse');
            }
        }

        // 检查答案是否正确
        function checkAnswer(userAnswer) {
            const correctAnswer = questions[currentQuestion].correct;
            
            if (isMultiChoice) {
                // 多选题：检查数组是否相等
                if (!Array.isArray(userAnswer) || userAnswer.length !== correctAnswer.length) {
                    return false;
                }
                
                const sortedUserAnswer = [...userAnswer].sort((a, b) => a - b);
                const sortedCorrectAnswer = [...correctAnswer].sort((a, b) => a - b);
                
                return JSON.stringify(sortedUserAnswer) === JSON.stringify(sortedCorrectAnswer);
            } else {
                // 单选题
                return userAnswer === correctAnswer;
            }
        }

        // 显示正确答案
        function showCorrectAnswer() {
            const correctAnswer = questions[currentQuestion].correct;
            const answerElements = document.querySelectorAll('.answer');
            
            if (isMultiChoice) {
                // 多选题：标记所有正确选项
                correctAnswer.forEach(index => {
                    answerElements[index].classList.add('correct');
                });
                
                // 标记用户选择的错误选项
                answerElements.forEach((el, index) => {
                    if (el.classList.contains('selected') && !correctAnswer.includes(index)) {
                        el.classList.add('wrong');
                    }
                });
            } else {
                // 单选题：标记正确答案
                answerElements[correctAnswer].classList.add('correct');
                
                // 标记错误答案（如果用户选错了）
                answerElements.forEach((el, index) => {
                    if (el.classList.contains('selected') && index !== correctAnswer) {
                        el.classList.add('wrong');
                    }
                });
            }
            
            // 显示解释
            const explanation = document.createElement('div');
            explanation.style.cssText = `
                margin-top: 30px;
                padding: 20px;
                background-color: rgba(0,0,0,0.3);
                border-radius: 15px;
                font-size: 1.8rem;
                color: #ffdd00;
            `;
            explanation.textContent = `正确答案解释: ${questions[currentQuestion].explanation}`;
            
            // 插入解释
            const parent = answersSectionElement.parentNode;
            parent.insertBefore(explanation, answersSectionElement.nextSibling);
        }

        // 开始倒计时
        function startTimer() {
            clearInterval(timerInterval);
            timerValue = 30;
            timerElement.textContent = timerValue;
            startTime = Date.now();
            
            timerInterval = setInterval(() => {
                timerValue--;
                timerElement.textContent = timerValue;
                
                // 最后10秒闪烁效果
                if (timerValue <= 10) {
                    timerElement.classList.add('pulse');
                }
                
                // 时间到
                if (timerValue <= 0) {
                    clearInterval(timerInterval);
                    timeUp();
                }
            }, 1000);
        }

        // 时间到
        function timeUp() {
            if (isAnswered) return;
            
            isAnswered = true;
            const answerTime = getAnswerTime(); // 获取答题时间
            
            // 为未答题的用户记录
            users.forEach(user => {
                if (user.currentAnswer === null) {
                    user.answered++;
                }
            });
            
            // 保存数据
            saveUsersToStorage();
            
            // 显示正确答案
            showCorrectAnswer();
            
            // 启用下一题按钮
            nextBtnElement.disabled = false;
            nextBtnElement.style.opacity = '1';
            nextBtnElement.style.cursor = 'pointer';
            
            // 更新排名
            updateRanking();
        }

        // 计算综合排名分数（考虑分数和时间）
        function calculateRankingScore(user) {
            // 基础：总分
            let rankingScore = user.score;
            
            // 时间因素：平均答题时间越短，加分越多
            if (user.avgTime && user.answered > 0) {
                // 平均时间越短，加分越多（30秒为满分，每少1秒加1分）
                const timeBonus = Math.max(0, 30 - user.avgTime);
                rankingScore += timeBonus * 2; // 时间权重加倍
            }
            
            // 准确率因素：正确率越高，加分越多
            if (user.answered > 0) {
                const accuracy = user.correct / user.answered;
                rankingScore += accuracy * 50; // 准确率权重
            }
            
            return rankingScore;
        }

        // 更新排名（考虑分数和时间）
        function updateRanking() {
            // 如果没有用户，显示提示
            if (users.length === 0) {
                rankingListElement.innerHTML = `
                    <div class="ranking-item">
                        <div class="rank rank-1">1</div>
                        <div class="user-info">
                            <div class="user-name">等待选手加入...</div>
                            <div class="user-time">扫描二维码参与答题</div>
                        </div>
                        <div class="score">0</div>
                    </div>
                `;
                return;
            }
            
            // 计算每个用户的综合排名分数
            users.forEach(user => {
                user.rankingScore = calculateRankingScore(user);
            });
            
            // 按综合排名分数排序
            const sortedUsers = [...users].sort((a, b) => {
                // 首先按综合排名分数排序
                if (b.rankingScore !== a.rankingScore) {
                    return b.rankingScore - a.rankingScore;
                }
                // 如果综合分数相同，按原始分数排序
                if (b.score !== a.score) {
                    return b.score - a.score;
                }
                // 如果分数也相同，按平均答题时间排序（时间短的优先）
                return (a.avgTime || 30) - (b.avgTime || 30);
            });
            
            // 清空排名列表
            rankingListElement.innerHTML = '';
            
            // 添加排名项
            sortedUsers.forEach((user, index) => {
                const rankingItem = document.createElement('div');
                rankingItem.className = 'ranking-item';
                
                // 排名
                const rankElement = document.createElement('div');
                rankElement.className = `rank rank-${index + 1}`;
                rankElement.textContent = index + 1;
                
                // 用户信息
                const userInfoElement = document.createElement('div');
                userInfoElement.className = 'user-info';
                
                const userNameElement = document.createElement('div');
                userNameElement.className = 'user-name';
                userNameElement.textContent = user.name;
                
                const userTimeElement = document.createElement('div');
                userTimeElement.className = 'user-time';
                if (user.avgTime) {
                    userTimeElement.textContent = `平均用时: ${user.avgTime.toFixed(1)}秒`;
                } else {
                    userTimeElement.textContent = `尚未答题`;
                }
                
                userInfoElement.appendChild(userNameElement);
                userInfoElement.appendChild(userTimeElement);
                
                // 分数
                const scoreElement = document.createElement('div');
                scoreElement.className = 'score';
                scoreElement.textContent = user.score;
                
                // 组装
                rankingItem.appendChild(rankElement);
                rankingItem.appendChild(userInfoElement);
                rankingItem.appendChild(scoreElement);
                
                rankingListElement.appendChild(rankingItem);
            });
        }

        // 下一题
        function nextQuestion() {
            // 切换到下一题
            currentQuestion++;
            
            if (currentQuestion >= questions.length) {
                // 所有题目已回答完毕
                endGame();
                return;
            }
            
            // 加载下一题
            loadQuestion(currentQuestion);
            
            // 重启定时器
            startTimer();
            
            // 禁用下一题按钮
            nextBtnElement.disabled = true;
            nextBtnElement.style.opacity = '0.5';
            nextBtnElement.style.cursor = 'not-allowed';
        }

        // 结束游戏
        function endGame() {
            questionNumberElement.textContent = "答题结束";
            questionTypeElement.textContent = "最终结果";
            questionTextElement.textContent = "恭喜完成UFI知识挑战赛！";
            answersSectionElement.innerHTML = '';
            
            const sortedUsers = [...users].sort((a, b) => {
                // 按最终排名规则排序
                if (b.rankingScore !== a.rankingScore) {
                    return b.rankingScore - a.rankingScore;
                }
                return b.score - a.score;
            });
            
            const topThree = sortedUsers.slice(0, 3);
            
            const winnerAnnouncement = document.createElement('div');
            winnerAnnouncement.style.cssText = `
                text-align: center;
                font-size: 2.5rem;
                margin-top: 50px;
                color: #ffdd00;
            `;
            
            let winnerText = "<div style='margin-bottom:30px;'><i class='fas fa-trophy' style='color:gold;'></i> 冠军: " + (topThree[0] ? topThree[0].name : '--') + " (" + (topThree[0] ? topThree[0].score : 0) + "分)</div>";
            if (topThree[1]) {
                winnerText += "<div style='margin-bottom:30px;'><i class='fas fa-medal' style='color:silver;'></i> 亚军: " + topThree[1].name + " (" + topThree[1].score + "分)</div>";
            }
            if (topThree[2]) {
                winnerText += "<div><i class='fas fa-award' style='color:#cd7f32;'></i> 季军: " + topThree[2].name + " (" + topThree[2].score + "分)</div>";
            }
            
            winnerAnnouncement.innerHTML = winnerText;
            answersSectionElement.appendChild(winnerAnnouncement);
            
            // 显示所有参赛者成绩
            if (sortedUsers.length > 0) {
                const allResults = document.createElement('div');
                allResults.style.cssText = `
                    margin-top: 40px;
                    padding: 20px;
                    background: rgba(255,255,255,0.1);
                    border-radius: 15px;
                    max-height: 300px;
                    overflow-y: auto;
                `;
                
                sortedUsers.forEach((user, index) => {
                    const resultItem = document.createElement('div');
                    resultItem.style.cssText = `
                        display: flex;
                        justify-content: space-between;
                        padding: 10px 0;
                        border-bottom: 1px solid rgba(255,255,255,0.1);
                    `;
                    
                    resultItem.innerHTML = `
                        <span>${index + 1}. ${user.name}</span>
                        <span>${user.score}分 (平均用时: ${user.avgTime ? user.avgTime.toFixed(1) : '--'}秒)</span>
                    `;
                    
                    allResults.appendChild(resultItem);
                });
                
                answersSectionElement.appendChild(allResults);
            }
            
            clearInterval(timerInterval);
            timerElement.textContent = "完成";
            nextBtnElement.disabled = true;
            nextBtnElement.style.opacity = '0.5';
            nextBtnElement.style.cursor = 'not-allowed';
        }

        // 重置游戏
        function resetGame() {
            if (confirm("确定要重置比赛吗？所有数据将被清空。")) {
                currentQuestion = 0;
                timerValue = 30;
                isAnswered = false;
                
                users.forEach(user => {
                    user.score = 0;
                    user.correct = 0;
                    user.answered = 0;
                    user.currentAnswer = null;
                    user.answerTimes = [];
                    user.avgTime = 0;
                    user.rankingScore = 0;
                });
                
                saveUsersToStorage();
                loadQuestion(0);
                startTimer();
                updateRanking();
                updateParticipantCount();
            }
        }

        // 页面加载完成后初始化
        document.addEventListener('DOMContentLoaded', initPage);
    </script>
</body>
</html>
